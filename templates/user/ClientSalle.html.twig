{% extends 'base2.html.twig' %}
{% block title %}
	User index
{% endblock %}
{% block body %}
	<h2 style="text-align: center;">Liste des clients</h2>
	<div class="d-flex justify-content-center mt-5">
		<div class="col-md-8 col-lg-6">
			<div class="input-group mb-4 shadow">
				<input type="text" id="search1" class="form-control" placeholder="Search..." aria-label="Search users">
		
			</div>
			
		</div>
	</div>


	<div class="row" id="17" style="margin-top: 10px">
		{% for user in users %}
			<div class="col-md-4">
				<div class="card mb-4 shadow-sm">
					<div
						class="row g-0">
						<!-- Adjusting avatar section size and placement -->
						<div class="col-md-5 d-flex align-items-center justify-content-center">
							{% if user.avatar %}
								<img src="{{ asset('uploads/images/' ~ user.avatar) }}" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
							{% endif %}
						</div>
						<div class="col-md-7">
							<div class="card-body">
								<h5 class="card-title">{{ user.nom }}
									{{ user.prenom }}</h5>
								<p class="card-text">
									<strong>Email:</strong>
									{{ user.email }}<br>
									<strong>Adresse:</strong>
									{{ user.adresse }}<br>
									<strong>Telephone:</strong>
									{{ user.num_tele }}
								</p>
							</div>
						</div>
					</div>
					<div class="card-footer bg-white">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<a class="btn btn-primary" href="{{ path('app_user_show', {'id': user.id}) }}">View</a>
								<a class="btn btn-secondary" href="{{ path('app_user_edit_Client', {'id': user.id}) }}">Edit</a>
								<a class="btn btn-dark" href="{{ path('app_user_update_password', {'id': user.id}) }}">Edit PWD</a>
								<button type="button" class="btn {{ user.is_verified ? 'btn-success' : 'btn-warning' }}" onclick="toggleVerification1('{{ user.id }}', '{{ csrf_token('toggle-verification' ~ user.id) }}')">
									{{ user.is_verified ? 'Desactivate' : 'Activate' }}
								</button>
							</div>
							<button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ user.id }}">
								Delete

							</button>
							<div class="modal fade" id="deleteModal{{ user.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ user.id }}" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="deleteModalLabel{{ user.id }}">
												Confirm Delete
											</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											Are you sure you want to delete this user?

										</div>
										<div class="modal-footer">
											<form method="POST" action="{{ path('app_user_delete', {'id': user.id}) }}">
												<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
												<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
													Cancel
												</button>
												<button type="submit" class="btn btn-danger">
													Delete
												</button>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		{% else %}
			<div class="col-12">
				<p class="text-center">No records found</p>
			</div>
		{% endfor %}

	</div>
	<script>
		function toggleVerification1(userId, csrfToken) {
console.log('userID', userId);
console.log('csrfToken', csrfToken);
fetch (`/user/${userId}/toggle-verification1`, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: `_token=${csrfToken}`
}).then(response => {
if (response.ok) {
window.location.reload(); // Reload the page to reflect changes
} else {
alert('Failed to toggle verification status.');
}
}).catch(error => console.error('Error:', error));
}
	</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		$(document).ready(function() {
			var originalContent = $('#17').html(); // Sauvegarder le contenu original
			var basePath = '/uploads/images/';
			$('#search1').keyup(function() {
				var query = $(this).val();
				
				if (query.length >= 1) {
					$.ajax({
						url: "{{ path('client_search1') }}", // Remplacez par votre route Symfony
						type: "GET",
						data: { 'q': query },
						success: function(data) {
							$('#17').empty(); // Vider le conteneur avant d'ajouter les nouveaux résultats
							if (data.users.length > 0) {
								$.each(data.users, function(i, user) {
									var avatarUrl = basePath + user.avatar;
									var csrfTokens = { // Generate a CSRF token for each user action. Adjust the 'id' as necessary.
		{% for user in users %}
		"{{ user.id }}" : "{{ csrf_token('toggle-verification' ~ user.id) }}",{% endfor %}
		}; // Utilisez la propriété csrfToken de l'objet user
									var deleteUrl = user.deleteUrl;
									var verificationText = user.is_verified ? 'Desactivate' : 'Activate';
									var verificationClass = user.is_verified ? 'btn-success' : 'btn-warning';
		var csrfToken = csrfTokens[user.id];
		var userHtml = '<div class="col-md-4">' +
			'<div class="card mb-4 shadow-sm">' +
			'<div class="row g-0">' +
			'<div class="col-md-5 d-flex align-items-center justify-content-center">' +
			'<img src="' + avatarUrl + '" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">' +
			'</div>' +
			'<div class="col-md-7">' +
			'<div class="card-body">' +
			'<h5 class="card-title">' + user.nom + ' ' + user.prenom + '</h5>' +
			'<p class="card-text">' +
			'<strong>Email:</strong> ' + user.email + '<br>' +
			'<strong>Adresse:</strong> ' + user.adresse + '<br>' +
			'<strong>Telephone:</strong> ' + user.num_tele +
			'</p>' +
			'</div>' +
			'</div>' +
			'</div>' +
			'<div class="card-footer bg-white">' +
			'<div class="d-flex justify-content-between align-items-center">' +
			'<div>' +
			'<a class="btn btn-primary" href="/user/showClient/' + user.id + '">View</a> ' +
			'<a class="btn btn-secondary" href="/user/' + user.id + '/editClient">Edit</a> ' +
			'<a class="btn btn-dark" href="/user/' + user.id + '/update-password">Edit PWD</a> ' +
			'<button type="button" class="btn ' + verificationClass + '" onclick="toggleVerification1(\'' + user.id + '\', \'' + csrfToken + '\')"> ' + verificationText + '</button>' +
			'</div>' +
			// Ici était le problème de concaténation
			'<button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal' + user.id + '">Delete</button>' +
			'</div>' +
			'</div>' +
			'</div>' +
			'</div>';
		
			userHtml += '<div class="modal fade" id="deleteModal' + user.id + '" tabindex="-1" aria-labelledby="deleteModalLabel' + user.id + '" aria-hidden="true">' +
			'<div class="modal-dialog">' +
			'<div class="modal-content">' +
			'<div class="modal-header">' +
			'<h5 class="modal-title">Confirm Delete</h5>' +
			'<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
			'</div>' +
			'<div class="modal-body">Are you sure you want to delete this user?</div>' +
			'<div class="modal-footer">' +
			'<form method="POST" action="/user/remove1/' + user.id + '">' + // Utilisez le chemin d'accès correct à votre action de contrôleur
			'<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
			'<button type="submit" class="btn btn-danger">Delete</button>' +
			'</form>' +
			'</div>' +
			'</div>' +
			'</div>' +
			'</div>';
		
		
		$('#17').append(userHtml);
		
								});
							} else {
								$('#17').html('<p>No users found.</p>'); // Afficher un message si aucun utilisateur n'est trouvé
							}
						}
					});
				} else {
					$('#17').html(originalContent); // Restaurer le contenu original si la recherche est vide
				}
			});
		});
		</script>
		{% endblock %}
